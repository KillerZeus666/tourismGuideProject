CREATE VIEW V_RATIOR AS
SELECT
    c.idCiudad,
    c.nombreCiudad,
    g.idGuia,
    g.nombre AS nombreGuia,
    t.total_valor,
    SUM(t.total_valor) OVER (
        PARTITION BY t.idCiudad
    ) AS total_ciudad,
    ROUND(
        100.0 * t.total_valor
        / SUM(t.total_valor) OVER (PARTITION BY t.idCiudad),
        2
    ) AS porcentaje_participacion
FROM (
    -- total por gu√≠a y ciudad
    SELECT
        h.idCiudad,
        h.idGuia,
        SUM(h.valorDia) AS total_valor
    FROM HechosGuiaCiudad h
    GROUP BY h.idCiudad, h.idGuia
) t
JOIN Ciudad c ON c.idCiudad = t.idCiudad
JOIN Guia g ON g.idGuia = t.idGuia;
